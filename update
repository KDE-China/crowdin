#!/bin/bash

# Author: Guo Yunhe <guoyunhebrave@gmail.com>
# Updated: 2018-04-05

# Update sources and translations from KDE SVN server.

# Load environment variables
source environment

echo "[SVN Update] start"

cd $ROOT_DIR/kf5-trunk
svn revert --depth=infinity .
svn cleanup --remove-unversioned $LOCALES_UNDERSCORE
svn up templates
svn up $LOCALES_UNDERSCORE

cd $ROOT_DIR/kf5-stable
svn revert --depth=infinity . # Revert unstaged changes
svn cleanup --remove-unversioned $LOCALES_UNDERSCORE # Remove unversioned files
svn up templates
svn up $LOCALES_UNDERSCORE

echo "[SVN Update] done"

echo "[Import Krita Document Templates] start"

rm $ROOT_DIR/kf5-trunk/templates/docmessages/extragear-graphics/krita--*

cd $ROOT_DIR/docs-krita-org
git reset
git pull
make gettext
cd _build/gettext

for file in $(find . -name "*.pot")
do
    file1="${file/\.\//}"
    file2="${file1//\//--}"
    mv $file "../../../kf5-trunk/templates/docmessages/extragear-graphics/krita--$file2"
done

echo "[Import Krita Document Templates] done"


echo "[Generate Missing Translations] start"

generate() {
    for pot in $(find -name "*.pot"); do
        for locale in $LOCALES_UNDERSCORE; do
            po="../$locale/$(echo $pot | sed 's/pot$/po/g')"
            if [ ! -f $po ]; then
                install -m 644 -Dv $pot $po
                svn add $po -q --parents >/dev/null
            fi
        done
    done
}

cd $ROOT_DIR/kf5-trunk/templates
generate

cd $ROOT_DIR/kf5-stable/templates
generate

echo "[Generate Missing Translations] done"
