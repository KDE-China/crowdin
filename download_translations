#!/bin/bash

# Load environment variables
source environment

./update

./backup_credits

echo "[Download Translations] start"

cd $ROOT_DIR/kf5-trunk
crowdin download -b kf5-trunk | grep " - "> lost.txt

cd $ROOT_DIR/kf5-stable
crowdin download -b kf5-stable | grep " - "> lost.txt

echo "[Download Translations] done"


echo "[Format Translations] start"

cd $ROOT_DIR

for po in $(find -name "*.po"); do
    msgcat -w 79 -o $po $po
done

echo "[Format Translations] done"

./restore_credits

echo "[Export Krita Document Translations] start"

for locale in $COMMIT_LOCALES_UNDERSCORE; do
    rm -r "$ROOT_DIR/docs-krita-org/locale/$locale/LC_MESSAGES"
    mkdir -p "$ROOT_DIR/docs-krita-org/locale/$locale/LC_MESSAGES"

    cd $ROOT_DIR/kf5-trunk/$locale/docmessages/extragear-graphics

    for file in $(find . -name "krita--*.po")
    do
        file1="${file/\.\/krita--/}"
        file2="${file1/--/\/}"
        mv $file "$ROOT_DIR/docs-krita-org/locale/$locale/LC_MESSAGES/$file2"
    done
done

cd $ROOT_DIR/docs-krita-org
git add --all

echo "[Export Krita Document Translations] done"
